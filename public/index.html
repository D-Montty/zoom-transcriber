<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Sales Call Transcriber</title>
  <!-- If you already have public/style.css, this will use it -->
  <link rel="stylesheet" href="style.css"/>
  <style>
    /* If you don't have style.css, this minimal style keeps it usable */
    *{box-sizing:border-box}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;background:linear-gradient(135deg,#667eea,#764ba2);min-height:100vh;margin:0;padding:24px}
    .container{max-width:900px;margin:0 auto}
    header{color:#fff;text-align:center;margin-bottom:20px}
    .card{background:#fff;border-radius:12px;padding:22px;box-shadow:0 12px 28px rgba(0,0,0,.12);margin-bottom:16px}
    label{display:block;font-weight:600;margin-bottom:6px}
    input{width:100%;padding:12px;border:2px solid #e6e6e6;border-radius:8px;font-size:16px}
    .buttons{display:flex;gap:10px;margin-top:14px;flex-wrap:wrap}
    button{border:0;padding:12px 20px;border-radius:8px;font-weight:700;cursor:pointer}
    #startBtn{background:#667eea;color:#fff}
    #stopBtn{background:#f56565;color:#fff}
    #copyBtn{background:#48bb78;color:#fff}
    .status{margin-top:12px;padding:10px;border-radius:8px;background:#bee3f8;color:#2c5282}
    .status.error{background:#fed7d7;color:#742a2a}
    .status.success{background:#c6f6d5;color:#22543d}
    #txCard{max-height:520px;overflow:auto}
    .row{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
    #tx{background:#f7f7f9;border-radius:8px;padding:16px;white-space:pre-wrap}
    footer{color:#fff;text-align:center;margin-top:12px;opacity:.9}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>üìù Sales Call Transcriber</h1>
      <p>Paste a Zoom link, start, stop, and copy the transcript.</p>
    </header>

    <div class="card">
      <label>Your Name</label>
      <input id="name" placeholder="e.g., Diego"/>

      <label style="margin-top:12px;">Zoom Meeting Link</label>
      <input id="zoom" placeholder="https://zoom.us/j/123..."/>

      <div class="buttons">
        <button id="startBtn">Start</button>
        <button id="stopBtn" disabled>Stop</button>
        <button id="copyBtn" disabled>Copy</button>
      </div>

      <div id="status" class="status"></div>
    </div>

    <div class="card" id="txCard" style="display:none;">
      <div class="row">
        <h2>Live Transcript</h2>
        <span id="duration"></span>
      </div>
      <pre id="tx">Waiting for audio‚Ä¶</pre>
    </div>

    <footer>
      üí° If Zoom shows a participant trying to join, please **Admit** it.
    </footer>
  </div>

  <script>
    const startBtn = document.getElementById('startBtn');
    const stopBtn  = document.getElementById('stopBtn');
    const copyBtn  = document.getElementById('copyBtn');
    const statusEl = document.getElementById('status');
    const txEl     = document.getElementById('tx');
    const txCard   = document.getElementById('txCard');
    const durEl    = document.getElementById('duration');

    let botId = null, poll = null, t0 = null, timer = null;

    function setStatus(msg, type="info"){
      console.log(`[STATUS:${type}]`, msg);
      statusEl.textContent = msg;
      statusEl.className = `status ${type}`;
      if(type!=="error") setTimeout(()=>{ if (statusEl.textContent === msg) statusEl.textContent = ""; }, 5000);
    }

    function setButtons({starting=false, running=false}){
      startBtn.disabled = starting || running;
      stopBtn.disabled  = !running;
      copyBtn.disabled  = !running;
    }

    async function start(){
      try{
        const name = document.getElementById('name').value.trim();
        const zoom = document.getElementById('zoom').value.trim();
        if(!zoom){ setStatus("Please paste a Zoom meeting link", "error"); return; }

        setButtons({starting:true, running:false});
        setStatus("Starting bot‚Ä¶ admit it in Zoom if prompted.");
        console.log("POST /api/start", { zoom_url: zoom, display_name: name });

        const r = await fetch("/api/start", {
          method:"POST",
          headers:{"Content-Type":"application/json"},
          body: JSON.stringify({ zoom_url: zoom, display_name: name })
        });

        const rawText = await r.text();
        let data = {};
        try { data = JSON.parse(rawText); } catch { data = { raw: rawText }; }
        console.log("START response:", r.status, data);

        if(!r.ok){
          const msg = data?.error || data?.details || data?.message || rawText || "Failed to start";
          setStatus(`Start error (${r.status}): ${msg}`, "error");
          setButtons({starting:false, running:false});
          return;
        }

        botId = data.bot_id;
        txCard.style.display = "block";
        txEl.textContent = "Waiting for audio‚Ä¶";
        setButtons({running:true});
        t0 = Date.now();
        timer = setInterval(()=>{
          const s = Math.floor((Date.now()-t0)/1000);
          const m = String(Math.floor(s/60)).padStart(2,"0");
          const ss = String(s%60).padStart(2,"0");
          durEl.textContent = `Duration ${m}:${ss}`;
        }, 1000);

        // Poll every 3s ‚Äî try live cache first, then REST fallback
        poll = setInterval(async ()=>{
          if (!botId) return;

          try {
            // 1) Live via webhook cache
            const live = await fetch(`/api/live?bot_id=${botId}`);
            if (live.ok) {
              const ld = await live.json();
              if (ld.hasData && typeof ld.transcript === "string") {
                txEl.textContent = ld.transcript || "(no speech yet)";
                txEl.scrollTop = txEl.scrollHeight;
                return; // got live text; skip REST this tick
              }
            }

            // 2) Fallback to REST transcript (may be empty until post-call)
            const rest = await fetch(`/api/transcript?bot_id=${botId}`);
            if (rest.ok) {
              const rd = await rest.json();
              if (rd.transcript && rd.transcript.trim()) {
                txEl.textContent = rd.transcript;
                txEl.scrollTop = txEl.scrollHeight;
              } else {
                console.debug("Transcript not ready yet (REST). State:", rd?.state);
              }
            } else {
              console.warn("REST transcript error", rest.status);
            }
          } catch (e) {
            console.error("Polling error:", e);
          }
        }, 3000);

      }catch(e){
        console.error("Start() crashed:", e);
        setStatus(`Unexpected error: ${e.message}`, "error");
        setButtons({starting:false, running:false});
      }
    }

    async function stop(){
      if(!botId) return;
      setStatus("Stopping‚Ä¶");
      setButtons({starting:false, running:false});
      try{
        const r = await fetch("/api/stop", {
          method:"POST",
          headers:{"Content-Type":"application/json"},
          body: JSON.stringify({ bot_id: botId })
        });
        const data = await r.json().catch(()=> ({}));
        console.log("STOP response:", r.status, data);

        if(!r.ok){
          setStatus(`Stop error (${r.status}): ${data?.error || data?.details || "Failed to stop"}`, "error");
        } else if (typeof data.transcript === "string" && data.transcript.trim()){
          txEl.textContent = data.transcript;
          setStatus("Transcript ready to copy ‚úÖ", "success");
        } else {
          // Keep polling until the final transcript appears
          setStatus("Final transcript is processing‚Ä¶");
          const pollUntilReady = async () => {
            const rr = await fetch(`/api/transcript?bot_id=${botId}`);
            const td = await rr.json().catch(()=> ({}));
            if (td.transcript && td.transcript.trim()) {
              txEl.textContent = td.transcript;
              setStatus("Transcript ready to copy ‚úÖ", "success");
            } else {
              setTimeout(pollUntilReady, 5000);
            }
          };
          pollUntilReady();
        }
      }catch(e){
        console.error("Stop() crashed:", e);
        setStatus(`Unexpected error: ${e.message}`, "error");
      }finally{
        botId = null;
        if(poll){ clearInterval(poll); poll = null; }
        if(timer){ clearInterval(timer); timer = null; durEl.textContent=""; }
        setButtons({starting:false, running:false});
      }
    }

    function copy(){
      const text = txEl.textContent || "";
      if(!text.trim()){ setStatus("Nothing to copy", "error"); return; }
      navigator.clipboard.writeText(text).then(
        ()=> setStatus("Transcript copied!", "success"),
        ()=> setStatus("Copy failed", "error")
      );
    }

    startBtn.onclick = start;
    stopBtn.onclick  = stop;
    copyBtn.onclick  = copy;

    // Keyboard shortcuts
    document.addEventListener("keydown", (e) => {
      if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==="s"){ e.preventDefault(); if(!startBtn.disabled) start(); }
      if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==="x"){ e.preventDefault(); if(!stopBtn.disabled)  stop(); }
      if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==="c"){ e.preventDefault(); if(!copyBtn.disabled)  copy(); }
    });
  </script>
</body>
</html>
