<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Sales Call Transcriber</title>
  <link rel="stylesheet" href="style.css"/>
  <style>
    *{box-sizing:border-box}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;background:linear-gradient(135deg,#667eea,#764ba2);min-height:100vh;margin:0;padding:24px}
    .container{max-width:900px;margin:0 auto}
    header{color:#fff;text-align:center;margin-bottom:20px}
    .card{background:#fff;border-radius:12px;padding:22px;box-shadow:0 12px 28px rgba(0,0,0,.12);margin-bottom:16px}
    label{display:block;font-weight:600;margin-bottom:6px}
    input{width:100%;padding:12px;border:2px solid #e6e6e6;border-radius:8px;font-size:16px}
    .buttons{display:flex;gap:10px;margin-top:14px;flex-wrap:wrap}
    button{border:0;padding:12px 20px;border-radius:8px;font-weight:700;cursor:pointer;transition:opacity 0.2s}
    button:disabled{opacity:0.5;cursor:not-allowed}
    button:hover:not(:disabled){opacity:0.9}
    #startBtn{background:#667eea;color:#fff}
    #stopBtn{background:#f56565;color:#fff}
    #copyBtn{background:#48bb78;color:#fff}
    #refreshBtn{background:#ed8936;color:#fff}
    #newSessionBtn{background:#9f7aea;color:#fff;display:none}
    .status{margin-top:12px;padding:10px;border-radius:8px;background:#bee3f8;color:#2c5282;font-size:14px}
    .status.error{background:#fed7d7;color:#742a2a}
    .status.success{background:#c6f6d5;color:#22543d}
    .status.warning{background:#feebc8;color:#7c2d12}
    .status.recording{background:#f0e7ff;color:#5b21b6;border:2px solid #9f7aea}
    #txCard{max-height:520px;overflow:auto}
    .row{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;flex-wrap:wrap;gap:8px}
    #tx{background:#f7f7f9;border-radius:8px;padding:16px;white-space:pre-wrap;min-height:150px;font-size:14px;line-height:1.6;border:1px solid #e5e5e5}
    footer{color:#fff;text-align:center;margin-top:12px;opacity:.9;font-size:14px}
    .recording-indicator{display:inline-flex;align-items:center;gap:8px;padding:8px 16px;background:#fee;border-radius:20px;color:#991b1b;font-weight:600;font-size:13px;border:2px solid #fca5a5}
    .rec-dot{width:8px;height:8px;background:#dc2626;border-radius:50%;animation:pulse 1.5s infinite}
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:0.3}}
    .timer{font-family:monospace;font-size:18px;font-weight:700;color:#667eea}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>üìù Sales Call Transcriber</h1>
      <p>Record your Zoom call and get the transcript when finished.</p>
    </header>

    <div class="card">
      <label>Your Name</label>
      <input id="name" placeholder="e.g., Diego"/>

      <label style="margin-top:12px;">Zoom Meeting Link</label>
      <input id="zoom" placeholder="https://zoom.us/j/123..."/>

      <div class="buttons">
        <button id="startBtn">Start Recording</button>
        <button id="stopBtn" disabled>Stop Recording</button>
        <button id="copyBtn" style="display:none">Copy Transcript</button>
        <button id="refreshBtn" style="display:none">Refresh Transcript</button>
        <button id="newSessionBtn">New Session</button>
      </div>

      <div id="status" class="status" style="display:none"></div>
      
      <div id="recordingStatus" style="display:none;margin-top:12px;text-align:center">
        <div class="recording-indicator">
          <span class="rec-dot"></span>
          <span>RECORDING</span>
        </div>
        <div class="timer" id="timer" style="margin-top:8px">00:00</div>
      </div>
    </div>

    <div class="card" id="txCard" style="display:none;">
      <div class="row">
        <h2>Transcript</h2>
      </div>
      <pre id="tx">No transcript yet.</pre>
    </div>

    <footer>
      üí° If Zoom shows a participant trying to join, please click <strong>Admit</strong>.
    </footer>
  </div>

  <script>
    const startBtn = document.getElementById('startBtn');
    const stopBtn  = document.getElementById('stopBtn');
    const copyBtn  = document.getElementById('copyBtn');
    const refreshBtn = document.getElementById('refreshBtn');
    const newSessionBtn = document.getElementById('newSessionBtn');
    const statusEl = document.getElementById('status');
    const txEl     = document.getElementById('tx');
    const txCard   = document.getElementById('txCard');
    const timerEl  = document.getElementById('timer');
    const recordingStatus = document.getElementById('recordingStatus');

    let botId = null, timer = null, t0 = null;

    function setStatus(msg, type="info"){
      console.log(`[STATUS:${type}]`, msg);
      statusEl.textContent = msg;
      statusEl.className = `status ${type}`;
      statusEl.style.display = msg ? 'block' : 'none';
      if(type!=="error" && type!=="warning" && type!=="recording") {
        setTimeout(()=>{ 
          if (statusEl.textContent === msg) statusEl.style.display = 'none';
        }, 5000);
      }
    }

    function setButtons({starting=false, running=false, hasFinalTranscript=false}){
      startBtn.disabled = starting || running || hasFinalTranscript;
      stopBtn.disabled  = !running;
      copyBtn.style.display = hasFinalTranscript ? 'inline-block' : 'none';
      refreshBtn.style.display = hasFinalTranscript ? 'inline-block' : 'none';
      newSessionBtn.style.display = hasFinalTranscript ? 'inline-block' : 'none';
      recordingStatus.style.display = running ? 'block' : 'none';
    }

    async function start(){
      try{
        const name = document.getElementById('name').value.trim();
        const zoom = document.getElementById('zoom').value.trim();
        if(!zoom){ setStatus("Please paste a Zoom meeting link", "error"); return; }

        setButtons({starting:true});
        setStatus("Starting bot... this may take 10-20 seconds.");
        console.log("POST /api/start", { zoom_url: zoom, display_name: name });

        const r = await fetch("/api/start", {
          method:"POST",
          headers:{"Content-Type":"application/json"},
          body: JSON.stringify({ zoom_url: zoom, display_name: name || "Sales Notetaker" })
        });

        const rawText = await r.text();
        let data = {};
        try { data = JSON.parse(rawText); } catch { data = { raw: rawText }; }
        console.log("START response:", r.status, data);

        if(!r.ok){
          const msg = data?.error || data?.details || data?.message || rawText || "Failed to start";
          setStatus(`Start error (${r.status}): ${msg}`, "error");
          setButtons({});
          return;
        }

        botId = data.bot_id;
        setButtons({running:true});
        setStatus("Bot joined the meeting. Recording in progress...", "recording");
        
        // Start timer
        t0 = Date.now();
        timer = setInterval(()=>{
          const s = Math.floor((Date.now()-t0)/1000);
          const m = String(Math.floor(s/60)).padStart(2,"0");
          const ss = String(s%60).padStart(2,"0");
          timerEl.textContent = `${m}:${ss}`;
        }, 1000);

      }catch(e){
        console.error("Start() crashed:", e);
        setStatus(`Unexpected error: ${e.message}`, "error");
        setButtons({});
      }
    }

    async function stop(){
      if(!botId) return;
      
      const currentBotId = botId;
      setStatus("Stopping recording and fetching transcript...");
      setButtons({});
      
      // Stop timer
      if(timer){ clearInterval(timer); timer = null; }
      
      try{
        const r = await fetch("/api/stop", {
          method:"POST",
          headers:{"Content-Type":"application/json"},
          body: JSON.stringify({ bot_id: currentBotId })
        });
        
        const data = await r.json().catch(()=> ({}));
        console.log("STOP response:", r.status, data);

        if(!r.ok){
          const msg = data?.error || data?.details || "Failed to stop";
          setStatus(`Stop error (${r.status}): ${msg}`, "error");
          return;
        }
        
        // Show transcript card
        txCard.style.display = "block";
        
        // Check if we got transcript immediately
        if (data.transcript && data.transcript.trim()){
          txEl.textContent = data.transcript;
          setButtons({hasFinalTranscript:true});
          setStatus("Recording stopped. Transcript ready!", "success");
          return;
        }
        
        // No transcript yet - poll for it
        setStatus("Processing final transcript... this may take 30-60 seconds.", "warning");
        txEl.textContent = "Processing transcript...\n\nThis usually takes 30-60 seconds after the call ends.\n\nClick 'Refresh Transcript' if it takes longer.";
        setButtons({hasFinalTranscript:true}); // Enable buttons so they can refresh
        
        let attempts = 0;
        const maxAttempts = 20;
        
        const pollFinal = async () => {
          attempts++;
          console.log(`Polling attempt ${attempts}/${maxAttempts}...`);
          
          try {
            const rr = await fetch(`/api/transcript?bot_id=${currentBotId}`);
            const td = await rr.json().catch(()=> ({}));
            console.log(`Transcript attempt ${attempts}:`, td);
            
            if (td.transcript && td.transcript.trim()) {
              txEl.textContent = td.transcript;
              setStatus("Transcript ready! Click Copy to copy it.", "success");
              return;
            }
            
            if (attempts < maxAttempts) {
              setTimeout(pollFinal, 5000);
            } else {
              setStatus("Transcript is taking longer than expected. Click Refresh to try again.", "warning");
            }
          } catch(e) {
            console.error("Polling error:", e);
            if (attempts < maxAttempts) {
              setTimeout(pollFinal, 5000);
            }
          }
        };
        
        pollFinal();
        
      }catch(e){
        console.error("Stop() crashed:", e);
        setStatus(`Unexpected error: ${e.message}`, "error");
      }
    }

    async function refreshTranscript(){
      if(!botId) return;
      setStatus("Refreshing transcript...");
      
      try {
        const r = await fetch(`/api/transcript?bot_id=${botId}`);
        const data = await r.json().catch(()=> ({}));
        console.log('Refresh response:', data);
        
        if (data.transcript && data.transcript.trim()) {
          txEl.textContent = data.transcript;
          setStatus("Transcript refreshed!", "success");
        } else {
          setStatus("Transcript still not ready. Wait a bit longer and try again.", "warning");
        }
      } catch(e) {
        setStatus("Error refreshing transcript", "error");
      }
    }

    function copy(){
      const text = txEl.textContent || "";
      if(!text.trim() || text.includes("Processing transcript") || text === "No transcript yet."){ 
        setStatus("Nothing to copy yet", "error"); 
        return; 
      }
      
      navigator.clipboard.writeText(text).then(
        ()=> setStatus("Transcript copied to clipboard!", "success"),
        (err)=> {
          setStatus("Copy failed - please select and copy manually", "error");
          // Fallback: select the text
          const range = document.createRange();
          range.selectNodeContents(txEl);
          const selection = window.getSelection();
          selection.removeAllRanges();
          selection.addRange(range);
        }
      );
    }

    function newSession(){
      botId = null;
      txCard.style.display = 'none';
      txEl.textContent = 'No transcript yet.';
      timerEl.textContent = '00:00';
      setButtons({});
      setStatus("");
    }

    startBtn.onclick = start;
    stopBtn.onclick  = stop;
    copyBtn.onclick  = copy;
    refreshBtn.onclick = refreshTranscript;
    newSessionBtn.onclick = newSession;
  </script>
</body>
</html>
